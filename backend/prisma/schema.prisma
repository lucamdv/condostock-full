generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// --- ENUMS DO SISTEMA ---

// Nível de acesso ao SOFTWARE
enum Role {
  ADMIN     // Síndico (Vê tudo)
  RESIDENT  // Usuário do App (Morador)
}

// Papel dentro da FAMÍLIA/APARTAMENTO
enum UnitRole {
  OWNER     // Titular (Pai - Pode adicionar/editar dependentes)
  MEMBER    // Dependente (Filho - Só edita o próprio perfil)
}

// Status de APROVAÇÃO
enum AccessStatus {
  ACTIVE    // Pode usar o sistema
  PENDING   // Aguardando aprovação do síndico
  REJECTED  // Cadastro negado
  BLOCKED   // Bloqueado por inadimplência (antigo active=false)
}

// --- CORE BACKSTOCK: PRODUTOS E ESTOQUE ---

model Product {
  id          String   @id @default(uuid())
  name        String
  description String?
  barcode     String?  @unique
  price       Decimal  @db.Decimal(10, 2)
  minStock    Int      @default(5) 
  imageUrl    String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  batches     Batch[]
  saleItems   SaleItem[]

  @@map("products")
}

model Batch {
  id          String    @id @default(uuid())
  code        String
  expiryDate  DateTime
  productId   String
  product     Product   @relation(fields: [productId], references: [id])
  
  stock       Stock?
  
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@map("batches")
}

model Stock {
  id        String   @id @default(uuid())
  batchId   String   @unique
  batch     Batch    @relation(fields: [batchId], references: [id])
  quantity  Int      
  
  updatedAt DateTime @updatedAt

  @@map("stocks")
}

// --- CONDOMÍNIO: MORADORES & FAMÍLIA ---

model Resident {
  id            String    @id @default(uuid())
  
  // --- Autenticação ---
  name          String
  cpf           String    @unique
  password      String
  isFirstLogin  Boolean   @default(true)
  
  // --- Permissões e Status (Lógica Nova) ---
  role          Role          @default(RESIDENT) // Admin ou Morador?
  unitRole      UnitRole      @default(OWNER)    // Pai ou Filho?
  status        AccessStatus  @default(ACTIVE)   // Síndico cria ACTIVE, Pai cria PENDING
  
  // --- Dados de Contato ---
  email         String?   
  phone         String?
  
  // --- Dados Residenciais ---
  apartment     String
  block         String
  
  // --- Hierarquia Familiar ---
  // Se for MEMBER, aponta para o OWNER (Pai)
  ownerId       String?       
  owner         Resident?     @relation("FamilyTree", fields: [ownerId], references: [id])
  dependents    Resident[]    @relation("FamilyTree")

  // --- Relações Financeiras ---
  account       ResidentAccount?
  sales         Sale[]

  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  @@map("residents")
}

model ResidentAccount {
  id            String    @id @default(uuid())
  residentId    String    @unique
  resident      Resident  @relation(fields: [residentId], references: [id])
  
  balance       Decimal   @default(0.00) @db.Decimal(10, 2)
  creditLimit   Decimal   @default(200.00) @db.Decimal(10, 2)
  
  status        AccountStatus @default(ACTIVE)

  updatedAt     DateTime @updatedAt

  @@map("resident_accounts")
}

enum AccountStatus {
  ACTIVE
  BLOCKED
}

// --- FRENTE DE LOJA (PDV) ---

model Sale {
  id          String      @id @default(uuid())
  total       Decimal     @db.Decimal(10, 2)
  status      SaleStatus  @default(COMPLETED)
  paymentType PaymentType 
  
  residentId  String?
  resident    Resident?   @relation(fields: [residentId], references: [id])

  items       SaleItem[]
  
  createdAt   DateTime    @default(now())

  @@map("sales")
}

enum SaleStatus {
  PENDING
  COMPLETED
  CANCELLED
}

enum PaymentType {
  CREDIT_CARD
  DEBIT_CARD
  PIX
  CASH
  FIADO
}

model SaleItem {
  id        String  @id @default(uuid())
  saleId    String
  sale      Sale    @relation(fields: [saleId], references: [id])
  
  productId String
  product   Product @relation(fields: [productId], references: [id])
  
  quantity  Int
  unitPrice Decimal @db.Decimal(10, 2)

  @@map("sale_items")
}